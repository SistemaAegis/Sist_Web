name: Despliegue a PRODUCCI√ìN (Main Branch)

on:
  # CR√çTICO: Activamos en el evento PUSH a 'main'. 
  # Esto se dispara inmediatamente despu√©s de que se fusiona un PR a 'main'.
  # Este evento garantiza el acceso completo a las Secrets del repositorio original.
  push:
    branches:
      - main
      
jobs:
  ## 1. Job: Construir y Publicar la Soluci√≥n en Docker
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar QEMU y Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: üîë Login a DockerHub
        uses: docker/login-action@v3
        with:
          # Secrets accesibles bajo el evento 'push'
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì¶ Construir y Publicar Imagen Docker (Ra√≠z)
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          tags: ${{ secrets.DOCKER_USER}}/frontend_next:latest 
          platforms: linux/amd64

    outputs:
      docker_user: ${{ secrets.DOCKER_USER}}
      

  ## 2. Job: Despliegue a Render
  deploy-to-render:
    needs: build-and-push # Depende de que la imagen se haya subido
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Iniciar Despliegue en Render (PROD)
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          # Secrets accesibles bajo el evento 'push'
          service_id: ${{ secrets.RENDER_SERVICE_ID }} 
          api_key: ${{ secrets.RENDER_API_KEY }}
          wait_deploy: true 
          


  ## 3. Job: Notificaci√≥n por Correo
  notify-result:
    if: always() 
    needs: [deploy-to-render] 
    runs-on: ubuntu-latest

    steps:
      - name: üìß Enviar Notificaci√≥n (√âxito o Fallo)
        uses: dawidd6/action-send-mail@v3
        with:
          subject: |
            ${{ contains(needs.deploy-to-render.result, 'failure') && '‚ùå FALLO' || '‚úÖ √âXITO' }} Despliegue a PRODUCCI√ìN (Main)
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          body: |
            **Estado del Pipeline:** ${{ contains(needs.deploy-to-render.result, 'failure') && 'FALLIDO' || 'EXITOSO' }}
            **Ambiente Desplegado:** PRODUCCI√ìN (Main)
            **Detalles del Despliegue:**
            - Repositorio: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Enlace al Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}