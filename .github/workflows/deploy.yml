name: Despliegue a PRODUCCI√ìN

on:
  # **ELIMINAR:** Ya no queremos que se active por un PUSH directo a main,
  # ya que el MERGE ya es un PUSH.
  # push:
  #   branches:
  #     - main
      
  # 2. Ejecuta solo cuando un Pull Request es cerrado (fusionado)
  pull_request:
    branches:
      - main
    types: 
      - closed # Solo cuando el PR es cerrado (puede ser fusionado o no)

jobs:
  # Job de condici√≥n: Solo despliega si el Pull Request fue FUSIONADO
  check-merge:
    runs-on: ubuntu-latest
    # CR√çTICO: Eliminar la condici√≥n de 'push' aqu√≠ y solo enfocarse en el merge del PR.
    # El flujo solo se activa si el PR fue cerrado Y si fue fusionado.
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    outputs:
      should_deploy: 'true'
      
    steps:
      - name: Verificar Fusi√≥n
        run: echo "Despliegue activado. Se procede con la construcci√≥n y el despliegue a PRODUCCI√ìN."

  ## 1. Job: Construir y Publicar la Soluci√≥n en Docker
  build-and-push:
    needs: check-merge
    # Solo se ejecuta si el job de verificaci√≥n dice que debe desplegar
    if: needs.check-merge.outputs.should_deploy == 'true' 
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar QEMU y Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: üîë Login a DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì¶ Construir y Publicar Frontend (Ra√≠z)
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          # Usamos la misma etiqueta
          tags: ${{ secrets.DOCKER_USER}}/frontend_next:latest 
          platforms: linux/amd64

    outputs:
      docker_user: ${{ secrets.DOCKER_USER}}
      

  ## 2. Job: Despliegue a Render
  deploy-to-render:
    needs: [check-merge, build-and-push] 
    if: success() && needs.check-merge.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Iniciar Despliegue en Render (PROD)
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          # Usamos el SERVICE_ID de Producci√≥n
          service_id: ${{ secrets.RENDER_SERVICE_ID}} 
          api_key: ${{ secrets.RENDER_API_KEY }}
          wait_deploy: true 

  ## 3. Job: Notificaci√≥n por Correo
  notify-result:
    if: always() 
    needs: [deploy-to-render] 
    runs-on: ubuntu-latest

    steps:
      - name: üìß Enviar Notificaci√≥n (√âxito o Fallo)
        uses: dawidd6/action-send-mail@v3
        with:
          subject: |
            ${{ contains(needs.deploy-to-render.result, 'failure') && '‚ùå FALLO' || '‚úÖ √âXITO' }} Despliegue a PRODUCCI√ìN (Main)
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          body: |
            **Estado del Pipeline:** ${{ contains(needs.deploy-to-render.result, 'failure') && 'FALLIDO' || 'EXITOSO' }}
            **Ambiente Desplegado:** PRODUCCI√ìN (Main)
            **Detalles del Despliegue:**
            - Repositorio: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Enlace al Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}