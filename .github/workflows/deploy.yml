name: Despliegue a Render

on:
  pull_request:
    branches:
      - main
    types:
      - closed   # Solo cuando se cierre el PR (incluye merge)

jobs:
  build-and-push:
    if: github.event.pull_request.merged == true  # Solo si se MERGE√ì
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar QEMU y Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: üîë Login a DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì¶ Construir y Publicar Imagen Docker (Ra√≠z)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USER }}/front_next:latest
          platforms: linux/amd64

  deploy-to-render:
    needs: build-and-push
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Iniciar Despliegue en Render
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          service_id: ${{ secrets.RENDER_SERVICE_ID }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          wait_deploy: true 

  notify-result:
    if: always() && github.event.pull_request.merged == true
    needs: deploy-to-render
    runs-on: ubuntu-latest

    steps:
      - name: üìß Enviar Notificaci√≥n (√âxito o Fallo)
        uses: dawidd6/action-send-mail@v3
        with:
          subject: |
            ${{ contains(needs.deploy-to-render.result, 'failure') && '‚ùå FALLO' || '‚úÖ √âXITO' }} Despliegue a Render
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          body: |
            Estado del Pipeline: ${{ contains(needs.deploy-to-render.result, 'failure') && 'FALLIDO' || 'EXITOSO' }}
            Repositorio: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
