name: Despliegue a Render

on:
  pull_request:
    branches:
      - main


jobs:
  ## 1. Job: Construir y Publicar la Soluci√≥n en Docker
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar QEMU y Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: üîë Login a DockerHub
        uses: docker/login-action@v3
        with:
          # Secrets para el login
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì¶ Construir y Publicar Imagen Docker (Ra√≠z)
        uses: docker/build-push-action@v5
        with:
          # Contexto de construcci√≥n en la ra√≠z del repositorio
          context: . 
          push: true
          # Etiqueta de la imagen
          tags: ${{ secrets.DOCKER_USER}}/front_next:latest 
          platforms: linux/amd64

    outputs:
      docker_user: ${{ secrets.DOCKER_USER}}
       
  ## 2. Job: Despliegue a Render
  deploy-to-render:
    needs: build-and-push # Espera a que la imagen se haya subido
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Iniciar Despliegue en Render
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          # Secrets para el despliegue en Render
          service_id: ${{ secrets.RENDER_SERVICE_ID }} 
          api_key: ${{ secrets.RENDER_API_KEY }}
          # Espera a que el despliegue termine
          wait_deploy: true 
 
  ## 3. Job: Notificaci√≥n por Correo
  notify-result:
    # Se ejecuta SIEMPRE (incluso si el despliegue fall√≥), gracias a if: always()
    if: always() 
    needs: [deploy-to-render] 
    runs-on: ubuntu-latest

    steps:
      - name: üìß Enviar Notificaci√≥n (√âxito o Fallo)
        uses: dawidd6/action-send-mail@v3
        with:
          # Asunto din√°mico basado en el resultado del job anterior
          subject: |
            ${{ contains(needs.deploy-to-render.result, 'failure') && '‚ùå FALLO' || '‚úÖ √âXITO' }} Despliegue a Render
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          body: |
            **Estado del Pipeline:** ${{ contains(needs.deploy-to-render.result, 'failure') && 'FALLIDO' || 'EXITOSO' }}
            **Detalles del Despliegue:**
            - Repositorio: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Enlace al Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}