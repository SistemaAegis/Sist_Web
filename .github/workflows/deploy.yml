name: Despliegue a Render

on:
  push:
    branches:
      - dev


jobs:
  ## 1. Job: Construir y Publicar la Soluci√≥n en Docker
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar QEMU y Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: üîë Login a DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ATENCI√ìN: Se modific√≥ el 'context' a la ra√≠z (./)
      - name: üì¶ Construir y Publicar Frontend (Ra√≠z)
        uses: docker/build-push-action@v5
        with:
          # Contexto de construcci√≥n en la ra√≠z del repositorio, como solicitaste.
          context: . 
          push: true
          # Aseg√∫rate de que esta etiqueta coincida con la que Render est√° configurado para usar.
          tags: ${{ secrets.DOCKER_USER}}/front_next:latest 
          platforms: linux/amd64

    outputs:
      docker_user: ${{ secrets.DOCKER_USER}} # Se mantiene por si lo quieres usar en el email
      

  ## 2. Job: Despliegue a Render
  deploy-to-render:
    needs: build-and-push # Depende de que la imagen se haya subido
    runs-on: ubuntu-latest
    
    steps:
      # Despliega la √∫ltima versi√≥n de la imagen Docker en Render
      - name: üöÄ Iniciar Despliegue en Render
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          # Estas secrets deben estar configuradas en tu repositorio de GitHub
          service_id: ${{ secrets.RENDER_SERVICE_ID }} 
          api_key: ${{ secrets.RENDER_API_KEY }}
          # Espera a que el despliegue termine (√©xito o fallo) antes de pasar al siguiente job
          wait_deploy: true 
#https://api.render.com/deploy/?key=os6edXetcFc
  ## 3. Job: Notificaci√≥n por Correo
  notify-result:
    # Se ejecuta si el despliegue a Render ha tenido √©xito o si ha fallado.
    if: always() 
    needs: [deploy-to-render] 
    runs-on: ubuntu-latest

    steps:
      - name: üìß Enviar Notificaci√≥n (√âxito o Fallo)
        uses: dawidd6/action-send-mail@v3
        with:
          # El 'subject' refleja si el job anterior (deploy-to-render) fall√≥ o tuvo √©xito
          subject: |
            ${{ contains(needs.*.result, 'failure') && '‚ùå FALLO' || '‚úÖ √âXITO' }} Despliegue a Render
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          body: |
            **Estado del Pipeline:** ${{ contains(needs.*.result, 'failure') && 'FALLIDO' || 'EXITOSO' }}
            **Detalles del Despliegue:**
            - Repositorio: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Enlace al Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            # Puedes a√±adir aqu√≠ el URL de tu servicio Render si lo tienes en otra secret, por ejemplo:
            # - URL del Servicio: https://${{ secrets.RENDER_SERVICE_URL }}